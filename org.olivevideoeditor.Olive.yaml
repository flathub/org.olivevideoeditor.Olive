app-id: org.olivevideoeditor.Olive
default-branch: beta
desktop-file-name-suffix: ' (Beta)'
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15-21.08'
command: olive-editor
finish-args:
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=host
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/*.a
  - /lib/*.la
  - /share/cmake
modules:

  - name: openexr
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: git
        url: https://github.com/AcademySoftwareFoundation/openexr.git
        commit: c32f82c5f1833d959321fc5f615ca52836c7ba65
        tag: v2.5.3

  - name: fmtlib
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DFMT_TEST=OFF
    sources:
      - type: git
        url: https://github.com/fmtlib/fmt.git
        commit: 7bdf0628b1276379886c7f6dda2cef2b3b374f0b
        tag: '7.1.3'

  - name: robin-map
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: git
        url: https://github.com/Tessil/robin-map.git
        commit: 622443f40544fb6a693402e69c1328d685eac939
        tag: v0.6.3

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=filesystem,system,thread
      - ./b2 install variant=release link=shared runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.74.0/source/boost_1_74_0.tar.bz2
        sha256: 83bfc1507731a0906e387fc28b7ef5417d591429e51e788417fe9ff025e116b1

  - name: OpenImageIO
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DVERBOSE=ON
      - -DOIIO_BUILD_TOOLS=OFF
      - -DOIIO_BUILD_TESTS=OFF
      - -DBUILD_DOCS=OFF
      - -DUSE_PYTHON=OFF
    sources:
      - type: git
        url: https://github.com/OpenImageIO/oiio.git
        commit: 8c1ab4bb18a22caccd6227ddbdbfc9176a941d71
        tag: v2.2.20.0

  - name: yaml-cpp
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -DYAML_CPP_BUILD_TESTS=OFF
    sources:
      - type: git
        url: https://github.com/jbeder/yaml-cpp.git
        commit: 9a3624205e8774953ef18f57067b3426c1c5ada6
        tag: yaml-cpp-0.6.3

  - name: pystring
    buildsystem: simple
    build-commands:
      - sed -e 's|/usr|/app|g' -i Makefile
      - make -j $FLATPAK_BUILDER_N_JOBS install
      - install -Dm644 pystring.h -t /app/include/pystring
    sources:
      - type: git
        url: https://github.com/imageworks/pystring.git
        commit: c2de99deb4f0bd13751f8436400b5e8662301769
        tag: v1.1.3

  - name: expat
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/libexpat/libexpat/releases/download/R_2_4_8/expat-2.4.8.tar.gz
        sha256: 398f6d95bf808d3108e27547b372cb4ac8dc2298a3c4251eb7aa3d4c6d4bb3e2
        x-checker-data:
          type: anitya
          project-id: 770
          stable-only: true
          url-template: https://github.com/libexpat/libexpat/releases/download/R_${major}_${minor}_${patch}/expat-$version.tar.gz

  - name: imath
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/AcademySoftwareFoundation/Imath/archive/refs/tags/v3.1.5.tar.gz
        sha256: 1e9c7c94797cf7b7e61908aed1f80a331088cc7d8873318f70376e4aed5f25fb
        x-checker-data:
          type: anitya
          project-id: 223366
          stable-only: true
          url-template: https://github.com/AcademySoftwareFoundation/Imath/archive/refs/tags/v$version.tar.gz

  - name: OpenColorIO
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DOCIO_BUILD_STATIC=OFF
      - -DOCIO_BUILD_APPS=OFF
      - -DOCIO_BUILD_TESTS=OFF
      - -DOCIO_BUILD_GPU_TESTS=OFF
      - -DOCIO_BUILD_PYTHON=OFF
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DOCIO_USE_SSE=NO
    cleanup:
      - /bin
    sources:
      - type: git
        url: https://github.com/AcademySoftwareFoundation/OpenColorIO.git
        commit: e670cd98d794e83cd5a9d079f8979d9204466128
        tag: v2.1.2

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: git
        url: https://code.videolan.org/videolan/x264.git
        commit: d198931a63049db1f2c92d96c34904c69fde8117

  - name: 'x265'
    buildsystem: cmake-ninja
    builddir: true
    subdir: source
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DENABLE_CLI=OFF
    sources:
      - type: archive
        url: https://deb.debian.org/debian/pool/main/x/x265/x265_3.4.orig.tar.gz
        sha256: c2047f23a6b729e5c70280d23223cb61b57bfe4ad4e8f1471eeee2a61d148672

  - name: ffmpeg
    config-opts:
      - --disable-static
      - --enable-shared
      - --disable-debug
      - --disable-doc
      - --enable-gpl
      - --disable-programs
      - --enable-libopus
      - --enable-libvpx
      - --enable-librsvg
      - --enable-libx264
      - --enable-libx265
      - --enable-libmp3lame
    cleanup:
      - /share/ffmpeg/examples
    sources:
      - type: archive
        url: https://www.ffmpeg.org/releases/ffmpeg-4.2.4.tar.xz
        sha256: 0d5da81feba073ee78e0f18e0966bcaf91464ae75e18e9a0135186249e3d2a0b

  - name: portaudio
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz
        sha256: 5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0

  - name: OpenTimelineIO
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_CXX_STANDARD=17
      - -DOTIO_PYTHON_INSTALL=OFF
    sources:
      - type: git
        url: https://github.com/AcademySoftwareFoundation/OpenTimelineIO.git
        commit: 8cdda64f5ef924855ce503822e1aeb125e6b011e
        tag: v0.14.1

  - name: olive
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DUSE_WERROR=OFF
    sources:
      - type: git
        url: https://github.com/olive-editor/olive.git
        commit: 55d3915881b36161db6240d7e3ad7decc4730337
      - type: patch
        path: olive-gl.patch
